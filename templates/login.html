{% extends "base.html" %}

{% block title %}Login - Nostr Marketplace{% endblock %}

{% block content %}
<section class="login-section py-5">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-6 col-lg-5">
                <div class="login-card">
                    <div class="text-center mb-4">
                        <h2 class="mb-3">
                            <i class="fas fa-bolt text-orange me-2"></i>
                            Connect to NostrMarket
                        </h2>
                        <p class="text-muted">
                            Authenticate with your Nostr identity to start trading
                        </p>
                    </div>

                    <!-- Extension Login -->
                    <div class="auth-method mb-4" id="extension-auth">
                        <div class="auth-header">
                            <h5>
                                <i class="fas fa-puzzle-piece text-purple me-2"></i>
                                Browser Extension
                            </h5>
                            <p class="text-muted small">Recommended for security</p>
                        </div>
                        
                        <div id="extension-status" class="mb-3">
                            <div class="alert alert-info" role="alert">
                                <i class="fas fa-search me-2"></i>
                                Checking for Nostr extension...
                            </div>
                        </div>
                        
                        <button type="button" class="btn btn-purple w-100" id="connect-extension" disabled>
                            <i class="fas fa-link me-2"></i>
                            Connect Extension
                        </button>
                        
                        <div class="mt-2">
                            <small class="text-muted">
                                Need an extension? Install 
                                <a href="https://getalby.com" target="_blank" class="text-orange">Alby</a> or 
                                <a href="https://github.com/fiatjaf/nos2x" target="_blank" class="text-orange">nos2x</a>
                            </small>
                        </div>
                    </div>

                    <div class="auth-divider">
                        <span>or</span>
                    </div>

                    <!-- Manual Login -->
                    <div class="auth-method" id="manual-auth">
                        <div class="auth-header">
                            <h5>
                                <i class="fas fa-key text-orange me-2"></i>
                                Manual Entry
                            </h5>
                            <p class="text-muted small">Enter your npub (public key only)</p>
                        </div>
                        
                        <form id="manual-login-form">
                            <div class="mb-3">
                                <label for="npub" class="form-label">Nostr Public Key (npub)</label>
                                <input type="text" class="form-control" id="npub" name="npub" 
                                       placeholder="npub1..." maxlength="63">
                                <div class="form-text">
                                    <i class="fas fa-shield-alt text-success me-1"></i>
                                    <strong>Never enter your private key (nsec)</strong>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="name" class="form-label">Display Name (Optional)</label>
                                <input type="text" class="form-control" id="name" name="name" 
                                       placeholder="Your name">
                            </div>
                            
                            <button type="submit" class="btn btn-orange w-100">
                                <i class="fas fa-sign-in-alt me-2"></i>
                                Connect with npub
                            </button>
                        </form>
                    </div>

                    <!-- Security Warning -->
                    <div class="security-warning mt-4">
                        <div class="alert alert-warning" role="alert">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Security Notice:</strong> 
                            Manual login provides read-only access. For full functionality 
                            (creating listings, payments), use a browser extension.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Loading Modal -->
<div class="modal fade" id="loading-modal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content text-center p-4">
            <div class="spinner-border text-orange mb-3" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mb-0">Authenticating...</p>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const challenge = '{{ challenge }}';
    let extensionAvailable = false;
    
    // Check for Nostr extension
    checkNostrExtension();
    
    function checkNostrExtension() {
        const statusDiv = document.getElementById('extension-status');
        const connectBtn = document.getElementById('connect-extension');
        
        if (window.nostr) {
            extensionAvailable = true;
            statusDiv.innerHTML = `
                <div class="alert alert-success" role="alert">
                    <i class="fas fa-check me-2"></i>
                    Nostr extension detected and ready!
                </div>
            `;
            connectBtn.disabled = false;
        } else {
            // Wait a bit for extension to load
            setTimeout(() => {
                if (window.nostr) {
                    checkNostrExtension();
                } else {
                    statusDiv.innerHTML = `
                        <div class="alert alert-warning" role="alert">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            No Nostr extension found. Please install one or use manual entry.
                        </div>
                    `;
                }
            }, 1000);
        }
    }
    
    // Extension authentication
    document.getElementById('connect-extension').addEventListener('click', async function() {
        if (!extensionAvailable) {
            alert('No Nostr extension found. Please install Alby or nos2x.');
            return;
        }
        
        try {
            showLoading();
            
            // Get public key
            const pubkey = await window.nostr.getPublicKey();
            
            // Create auth event
            const authEvent = {
                kind: 22242,
                created_at: Math.floor(Date.now() / 1000),
                tags: [
                    ['challenge', challenge],
                    ['relay', window.location.origin]
                ],
                content: ''
            };
            
            // Sign the event
            const signedEvent = await window.nostr.signEvent(authEvent);
            
            // Send to server
            const response = await fetch('/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    auth_type: 'extension',
                    event: signedEvent
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                window.location.href = result.redirect;
            } else {
                hideLoading();
                alert('Authentication failed: ' + result.error);
            }
            
        } catch (error) {
            hideLoading();
            console.error('Extension auth error:', error);
            alert('Authentication failed: ' + error.message);
        }
    });
    
    // Manual authentication
    document.getElementById('manual-login-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const npub = document.getElementById('npub').value.trim();
        const name = document.getElementById('name').value.trim();
        
        if (!npub) {
            alert('Please enter your npub');
            return;
        }
        
        // Validate npub format
        if (!npub.startsWith('npub') || npub.length !== 63) {
            alert('Invalid npub format. Please check your input.');
            return;
        }
        
        // Check for nsec accidentally entered
        if (npub.startsWith('nsec')) {
            alert('⚠️ SECURITY WARNING: You entered a private key (nsec)! Please use your public key (npub) instead.');
            document.getElementById('npub').value = '';
            return;
        }
        
        try {
            showLoading();
            
            const response = await fetch('/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    auth_type: 'manual',
                    npub: npub,
                    name: name
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                window.location.href = result.redirect;
            } else {
                hideLoading();
                alert('Authentication failed: ' + result.error);
            }
            
        } catch (error) {
            hideLoading();
            console.error('Manual auth error:', error);
            alert('Authentication failed. Please try again.');
        }
    });
    
    // Utility functions
    function showLoading() {
        const modal = new bootstrap.Modal(document.getElementById('loading-modal'));
        modal.show();
    }
    
    function hideLoading() {
        const modal = bootstrap.Modal.getInstance(document.getElementById('loading-modal'));
        if (modal) {
            modal.hide();
        }
    }
    
    // Auto-detect and warn about nsec in npub field
    document.getElementById('npub').addEventListener('input', function() {
        const value = this.value.trim();
        if (value.startsWith('nsec')) {
            this.classList.add('is-invalid');
            if (!document.querySelector('.nsec-warning')) {
                const warning = document.createElement('div');
                warning.className = 'invalid-feedback nsec-warning';
                warning.innerHTML = '<i class="fas fa-exclamation-triangle me-1"></i>This is a private key! Use your npub instead.';
                this.parentNode.appendChild(warning);
            }
        } else {
            this.classList.remove('is-invalid');
            const warning = document.querySelector('.nsec-warning');
            if (warning) {
                warning.remove();
            }
        }
    });
});
</script>
{% endblock %}
