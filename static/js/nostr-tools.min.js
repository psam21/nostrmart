/*! nostr-tools v1.17.0 - MIT License */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).nostrTools={})}(this,function(e){"use strict";const t="0123456789abcdefghijklmnopqrstuvwxyz";function r(e){const r=[];for(let n=0;n<e.length;n++){const o=e.charCodeAt(n);if(o<128)r.push(o);else if(o<2048)r.push(192|o>>6),r.push(128|63&o);else if(o<55296||o>=57344)r.push(224|o>>12),r.push(128|o>>6&63),r.push(128|63&o);else{if(o>=56320)throw new Error("Invalid Unicode code point");n++;const i=e.charCodeAt(n);if(i<56320||i>=57344)throw new Error("Invalid Unicode code point");const a=65536+(o-55296<<10)+(i-56320);r.push(240|a>>18),r.push(128|a>>12&63),r.push(128|a>>6&63),r.push(128|63&a)}}return new Uint8Array(r)}function n(e){const t=[];for(let r=0;r<e.length;r++){const n=e[r];if(n<128)t.push(String.fromCharCode(n));else if(n>>5==6){const o=e[++r];t.push(String.fromCharCode((31&n)<<6|63&o))}else if(n>>4==14){const o=e[++r],i=e[++r];t.push(String.fromCharCode((15&n)<<12|(63&o)<<6|63&i))}else if(n>>3==30){const o=e[++r],i=e[++r],a=e[++r],s=((7&n)<<18|(63&o)<<12|(63&i)<<6|63&a)-65536;t.push(String.fromCharCode(55296+(s>>10)),String.fromCharCode(56320+(1023&s)))}}return t.join("")}function o(e){const t=e.split("");for(let e=0;e<t.length-1;e++)Math.random()<.5&&([t[e],t[e+1]]=[t[e+1],t[e]]);return t.join("")}function i(e){const r=new TextEncoder;return async function(n,...o){const i=await crypto.subtle.importKey("raw",r.encode(n),"HMAC",!1,["sign"]),a=[];for(const e of o){const n="string"==typeof e?r.encode(e):e;a.push(await crypto.subtle.sign("HMAC",i,n))}return new Uint8Array(a.reduce((e,t)=>{const r=new Uint8Array(e.byteLength+t.byteLength);return r.set(new Uint8Array(e),0),r.set(new Uint8Array(t),e.byteLength),r}))}}function a(e){let t="";for(let r=0;r<e.length;r++)t+=e[r].toString(16).padStart(2,"0");return t}function s(e){const t=[];for(let r=0;r<e.length;r+=2)t.push(parseInt(e.substr(r,2),16));return new Uint8Array(t)}function c(e,r){let n=BigInt(0);for(const t of e)n=n<<8n|BigInt(t);const o=[];for(;n>0n;)o.unshift(Number(n%BigInt(r.length))),n/=BigInt(r.length);return 0===e[0]&&o.unshift(0),o.map(e=>r[e]).join("")}function u(e,r){let n=BigInt(0);for(let t=0;t<e.length;t++){const o=r.indexOf(e[t]);if(-1===o)throw new Error(`Invalid character: ${e[t]}`);n=n*BigInt(r.length)+BigInt(o)}const o=[];for(;n>0n;)o.unshift(Number(n%256n)),n/=256n;const i=e.match(/^0+/);return i&&o.unshift(...new Array(i[0].length).fill(0)),new Uint8Array(o)}const l=i("sha256"),f=i("sha512");function d(e){const t=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298];let r=[1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225],n=e.length*8,o=e.slice();o.push(128);const i=o.length%64;i<=56?o.push(...new Array(56-i).fill(0)):o.push(...new Array(120-i).fill(0)),o.push(...new Array(8).fill(0));for(let e=0;e<8;e++)o[o.length-8+e]=n>>8*(7-e)&255;for(let e=0;e<o.length;e+=64){const n=new Uint32Array(64);for(let t=0;t<16;t++)n[t]=o[e+4*t]<<24|o[e+4*t+1]<<16|o[e+4*t+2]<<8|o[e+4*t+3];for(let e=16;e<64;e++){const t=(n[e-15]>>>7|n[e-15]<<25)^(n[e-15]>>>18|n[e-15]<<14)^n[e-15]>>>3,r=(n[e-2]>>>17|n[e-2]<<15)^(n[e-2]>>>19|n[e-2]<<13)^n[e-2]>>>10;n[e]=n[e-16]+t+n[e-7]+r}let i=[...r];for(let e=0;e<64;e++){const r=(i[4]>>>6|i[4]<<26)^(i[4]>>>11|i[4]<<21)^(i[4]>>>25|i[4]<<7),o=i[4]&i[5]^~i[4]&i[6],a=(i[0]>>>2|i[0]<<30)^(i[0]>>>13|i[0]<<19)^(i[0]>>>22|i[0]<<10),s=i[0]&i[1]^i[0]&i[2]^i[1]&i[2],c=i[7]+r+o+t[e]+n[e],u=a+s;i=[u+c,...i.slice(0,4),i[4]+c,...i.slice(5,7)]}for(let e=0;e<8;e++)r[e]+=i[e]}const a=new Uint8Array(32);for(let e=0;e<8;e++)for(let t=0;t<4;t++)a[4*e+t]=r[e]>>8*(3-t)&255;return a}const h="qpzry9x8gf2tvdw0s3jn54khce6mua7l";function p(e){return function(e){let t=1;for(let r=0;r<e.length;++r){const n=t>>25;t=(33554431&t)<<5^e[r];for(let e=0;e<5;++e)1&n>>e&&(t^=[996825010,642813549,513874426,1027748829,705979059][e])}return t}([3,0,20,2,...g(e),...[0,0,0,0,0,0]])}function g(e){const t=[];for(const r of e)t.push(r>>5),t.push(31&r);return t}function y(e,t){const r=u(e,h);if(r.length<6)throw new Error("Invalid bech32 string");const n=r.slice(0,-6),o=r.slice(-6),i=p(n);if(o.join("")!==i.toString(32).padStart(6,"0").split("").map(e=>parseInt(e,32)).join(""))throw new Error("Invalid bech32 checksum");let a,s=BigInt(0);for(const e of n)s=32n*s+BigInt(e);const c=[];for(;s>0n;)c.unshift(Number(s%256n)),s/=256n;if("npub"===t)a=new Uint8Array([0,...c]);else if("nsec"===t)a=new Uint8Array([1,...c]);else if("note"===t)a=new Uint8Array([2,...c]);else if("nprofile"===t)a=new Uint8Array([3,...c]);else if("nevent"===t)a=new Uint8Array([4,...c]);else if("nrelay"===t)a=new Uint8Array([5,...c]);else{if("naddr"!==t)throw new Error("Invalid prefix");a=new Uint8Array([6,...c])}return{type:t,data:a.slice(1)}}function w(e,t){let r,n;if("npub"===e)r=0,n=t;else if("nsec"===e)r=1,n=t;else if("note"===e)r=2,n=t;else if("nprofile"===e)r=3,n=t;else if("nevent"===e)r=4,n=t;else if("nrelay"===e)r=5,n=t;else{if("naddr"!==e)throw new Error("Invalid type");r=6,n=t}let o=BigInt(0);for(const e of[r,...n])o=256n*o+BigInt(e);const i=[];for(;o>0n;)i.unshift(Number(o%32n)),o/=32n;const a=e+"1"+i.map(e=>h[e]).join("");return function(e){const t=u(e.split("1")[1]||"",h),r=t.slice(0,-6),n=p(r).toString(32).padStart(6,"0").split("").map(e=>parseInt(e,32));return e.split("1")[0]+"1"+c([...r,...n],h)}(a)}const v=["","x","a","i","e","p","t","d","r","amount","lnurl","subject","name","summary","image","thumb","url","aes","alt","expiration","kind","l","L","m","relays","nonce","delegation","proxy"];function m(e,t){if(!Array.isArray(e)||"string"!=typeof e[0])return!1;if(!t.includes(e[0]))return!1;for(let t=1;t<e.length;t++)if("string"!=typeof e[t])return!1;return!0}const x=crypto.getRandomValues(new Uint8Array(32));async function b(e){const t=new TextEncoder;try{return await crypto.subtle.importKey("raw",t.encode(e),"Ed25519",!1,["sign"])}catch{return await crypto.subtle.importKey("raw",s(e),"Ed25519",!1,["sign"])}}async function E(e,t){try{const r=await crypto.subtle.sign("Ed25519",e,t);return a(new Uint8Array(r))}catch(r){if(!globalThis.crypto.web)throw r;const n=globalThis.crypto.web.getRandomValues(new Uint8Array(64)),o=await crypto.subtle.importKey("raw",n,{name:"HMAC",hash:"SHA-256"},!1,["sign"]),i=new TextEncoder,c=await crypto.subtle.sign("HMAC",o,i.encode("nostr")),u=s(a(new Uint8Array(c)).slice(0,64));return E(await b(a(u)),t)}}async function _(e){const t=new TextEncoder;try{return await crypto.subtle.importKey("raw",t.encode(e),"Ed25519",!1,["verify"])}catch{return await crypto.subtle.importKey("raw",s(e),"Ed25519",!1,["verify"])}}async function k(e,t,r){try{return await crypto.subtle.verify("Ed25519",e,s(t),r)}catch(n){if(!globalThis.crypto.web)throw n;const o=globalThis.crypto.web.getRandomValues(new Uint8Array(64)),i=await crypto.subtle.importKey("raw",o,{name:"HMAC",hash:"SHA-256"},!1,["sign"]),c=new TextEncoder,u=await crypto.subtle.sign("HMAC",i,c.encode("nostr")),l=s(a(new Uint8Array(u)).slice(0,64));return k(await _(a(l)),t,r)}}function A(e){const t=r(JSON.stringify([0,e.pubkey,e.created_at,e.kind,e.tags,e.content]));return a(d(t))}async function S(e,t){if("string"!=typeof e.id||64!==e.id.length||!/^[0-9a-f]+$/.test(e.id))return!1;if(A(e)!==e.id)return!1;try{const r=await _(e.pubkey);return await k(r,e.sig,s(e.id))}catch{return!1}}function T(e){return!!e&&"object"==typeof e&&"string"==typeof e.id&&"string"==typeof e.pubkey&&"string"==typeof e.sig&&"number"==typeof e.created_at&&"number"==typeof e.kind&&"string"==typeof e.content&&Array.isArray(e.tags)&&e.tags.every(e=>Array.isArray(e)&&e.every(e=>"string"==typeof e))}async function I(e,t){const r=A(e);return{...e,id:r,sig:await E(t,s(r))}}async function C(e){const t=a(crypto.getRandomValues(new Uint8Array(32))),r=await b(t);return{privateKey:t,publicKey:a(new Uint8Array(await crypto.subtle.exportKey("raw",r))).slice(2)}}function j(e){return a(crypto.getRandomValues(new Uint8Array(e)))}const N=["kind","ids","authors","since","until","limit","search","#e","#p","#a","#t","#d","#r","#i","#k","#l","#L","#m","#n","#P","#q","#s","#u","#x"],B={PROFILE_METADATA:0,TEXT_NOTE:1,RECOMMEND_RELAY:2,CONTACTS:3,ENCRYPTED_DIRECT_MESSAGE:4,EVENT_DELETION:5,REPOST:6,REACTION:7,BADGE_AWARD:8,GROUP_CHAT_MESSAGE:9,GROUP_CHAT_THREADED_REPLY:10,GROUP_THREAD:11,GROUP_THREAD_REPLY:12,SEAL:13,DIRECT_MESSAGE:14,GENERIC_REPOST:16,CHANNEL_CREATION:40,CHANNEL_METADATA:41,CHANNEL_MESSAGE:42,CHANNEL_HIDE_MESSAGE:43,CHANNEL_MUTE_USER:44,BLANK:255,REPORT:1984,ZAP_GOAL:9041,ZAP_REQUEST:9734,ZAP:9735,RELAY_LIST_METADATA:10002,WALLET_INFO:13194,CLIENT_AUTHENTICATION:22242,WALLET_REQUEST:23194,WALLET_RESPONSE:23195,NOSTR_CONNECT:24133,HTTP_AUTH:27235,CATEGORIZED_PEOPLE_LIST:30000,CATEGORIZED_BOOKMARK_LIST:30001,PROFILE_BADGES:30008,BADGE_DEFINITION:30009,INTEREST_LIST:30015,CREATE_OR_UPDATE_STALL:30017,CREATE_OR_UPDATE_PRODUCT:30018,MARKETPLACE_UI_UX:30019,PRODUCT_SOLD_AS_AUCTION:30020,LONG_FORM_CONTENT:30023,DRAFT_LONG_FORM_CONTENT:30024,EMOJI_LIST:30030,APPLICATION_SPECIFIC_DATA:30078,LIVE_EVENT:30311,USER_STATUS:30315,CLASSIFIED_LISTING:30402,DRAFT_CLASSIFIED_LISTING:30403,DATE_BASED_CALENDAR_EVENT:31922,TIME_BASED_CALENDAR_EVENT:31923,CALENDAR:31924,CALENDAR_EVENT_RSVP:31925,HANDLER_RECOMMENDATION:31989,HANDLER_INFORMATION:31990,VIDEO_EVENT:34235},O={REGULAR:0,WEBSOCKET_UPDATE:1,EXPIRATION:2,SUBJECT:3,SUMMARY:4,TITLE:5,DESCRIPTION:6,STATUS:7,CLIENT:8,RELAY:9,AMOUNT:10,LNURL:11,AES:12,ALT:13,IMAGE:14,SUBJECT_:15,DESCRIPTION_:16,PRICE:17,LOCATION:18,SHIPPING:19,PUBLISHED_AT:20,RELAYS:21,EMOJI:22,ENCRYPTED:23,REQUEST:24,WORD:25,PROXY:26,DELEGATION:27,CONTENT_WARNING:28,NONCE:29,LABEL:30,TITLE_:31,SUMMARY_:32};class R{constructor(e){this.url=e,this.socket=null,this.challenge=null,this._connected=!1}async connect(){if(this.socket)return;const e=this.url.startsWith("wss://")||this.url.startsWith("ws://");if(!e)throw new Error("Invalid relay URL");return new Promise((e,t)=>{let r=!1;this.socket=new WebSocket(this.url),this.socket.onopen=()=>{this._connected=!0,r=!0,e()},this.socket.onerror=e=>{r||(t(e),r=!0)},this.socket.onmessage=e=>{try{const t=JSON.parse(e.data);Array.isArray(t)&&("AUTH"===t[0]&&(this.challenge=t[1]),"NOTICE"===t[0]&&console.warn(`Notice from ${this.url}: ${t[1]}`))}catch{}}})}async disconnect(){this.socket&&(this.socket.close(),this.socket=null,this._connected=!1)}get connected(){return this._connected}async send(e){this.socket&&1===this.socket.readyState&&this.socket.send(JSON.stringify(e))}async subscribe(e,t){if(!Array.isArray(e)&&(e=[e]),!this.connected&&await this.connect(),e.some(e=>!function(e){if("object"!=typeof e||null===e)return!1;if("number"!=typeof e.kinds&&"undefined"!=typeof e.kinds&&(!Array.isArray(e.kinds)||!e.kinds.every(e=>"number"==typeof e)))return!1;if("string"!=typeof e.ids&&"undefined"!=typeof e.ids&&(!Array.isArray(e.ids)||!e.ids.every(e=>"string"==typeof e)))return!1;if("string"!=typeof e.authors&&"undefined"!=typeof e.authors&&(!Array.isArray(e.authors)||!e.authors.every(e=>"string"==typeof e)))return!1;if("undefined"!=typeof e.since&&"number"!=typeof e.since)return!1;if("undefined"!=typeof e.until&&"number"!=typeof e.until)return!1;if("undefined"!=typeof e.limit&&"number"!=typeof e.limit)return!1;for(const t in e)if(t.startsWith("#")){const r=e[t];if(!Array.isArray(r)||!r.every(e=>"string"==typeof e))return!1}return!0}(e)))throw new Error("Invalid filter");const r=o("subscription");return await this.send(["REQ",r,...e]),new M(this,r,t)}async publish(e,t){if(!T(e))throw new Error("Invalid event");!this.connected&&await this.connect();const r=o("event");return await this.send(["EVENT",e]),new Promise((n,o)=>{if(!this.socket)return void o(new Error("Not connected"));const i=setTimeout(()=>{a(),o(new Error("Publish timeout"))},t||5e3);let a=()=>{this.socket&&(this.socket.removeEventListener("message",s),clearTimeout(i))};const s=t=>{try{const t=JSON.parse(t.data);Array.isArray(t)&&"OK"===t[0]&&t[1]===e.id&&(a(),t[2]?n():o(new Error(t[3]||"Rejected by relay")))}catch{}};this.socket.addEventListener("message",s)})}async auth(e){if(!this.challenge)throw new Error("No AUTH challenge received");const t={kind:22242,created_at:Math.floor(Date.now()/1e3),tags:[["relay",this.url],["challenge",this.challenge]],content:""};await this.send(["AUTH",await I(t,await b(e))])}}class M{constructor(e,t,r){this.relay=e,this.id=t,this.onevent=r,this.oneose=null,this.closed=!1,this._setupListener()}_setupListener(){if(!this.relay.socket)return;const e=e=>{if(this.closed)return;try{const t=JSON.parse(e.data);if(Array.isArray(t)){const[e,r,...n]=t;("EVENT"===e&&r===this.id&&n[0]&&this.onevent&&this.onevent(n[0]),"EOSE"===e&&r===this.id&&this.oneose&&this.oneose(),"CLOSED"===e)&&r===this.id&&this.close()}}catch{}};this.relay.socket.addEventListener("message",e),this.cleanup=()=>{this.relay.socket&&this.relay.socket.removeEventListener("message",e)}}async close(){this.closed||(this.closed=!0,await this.relay.send(["CLOSE",this.id]),this.cleanup&&this.cleanup())}}function U(e,t,r={}){return function(e,t,r={}){const n=[];for(const o of e){const e=new R(o);n.push((async()=>{try{await e.connect();const n=await e.subscribe(t,e=>{r.onevent&&r.onevent(e,o)});return r.oneose&&(n.oneose=r.oneose),{relay:e,sub:n}}catch(t){return r.onerror&&r.onerror(t,o),null}})())}return Promise.all(n).then(e=>e.filter(Boolean))}(Array.isArray(e)?e:[e],t,r)}function L(e,t,r={}){return function(e,t,r={}){const n=[];for(const o of e){const e=new R(o);n.push((async()=>{try{return await e.connect(),{relay:e,result:await e.publish(t,r.timeout)}}catch(t){return r.onerror&&r.onerror(t,o),{relay:e,result:Promise.reject(t)}}})(x))}return Promise.all(n)}(Array.isArray(e)?e:[e],t,r)}const P=["wss://relay.damus.io","wss://relay.snort.social","wss://nos.lol","wss://relay.current.fyi"];function F(e,t){const r=new Set;for(const n of e)for(const e of n.tags)m(e,t)&&r.add(e[1]);return Array.from(r)}function D(e){const t=new Set;for(const r of e)for(const e of r.tags)m(e,["e"])&&4===e.length&&"reply"===e[3]&&t.add(e[1]);return Array.from(t)}function $(e){const t=new Set;for(const r of e)for(const e of r.tags)m(e,["e"])&&(4!==e.length||"reply"!==e[3])&&t.add(e[1]);return Array.from(t)}function q(e){return F(e,["p"])}function z(e,t){return e.filter(e=>e.kind===t)}function H(e,t){const r=e.find(e=>e.pubkey===t&&0===e.kind);return r?function(e){if(0!==e.kind)return{};try{return JSON.parse(e.content)}catch{return{}}}(r):{}}function W(e,t){const r=e.filter(e=>e.pubkey===t&&3===e.kind).sort((e,t)=>t.created_at-e.created_at)[0];return r?function(e){if(3!==e.kind)return[];const t=[];for(const r of e.tags)m(r,["p"])&&t.push(r[1]);return t}(r):[]}function G(e){const t=new Map;return e.forEach(e=>{const r=t.get(e.id);(!r||e.created_at>r.created_at)&&t.set(e.id,e)}),Array.from(t.values())}e.SimplePool=class{constructor(e={}){this.relays=new Map,this.seenOn=new Map,this.trackRelays=e.trackRelays||!1}async ensureRelay(e){let t=this.relays.get(e);return t||(t=new R(e),this.relays.set(e,t),await t.connect()),t}subscribe(e,t,r={}){const n=o("pool"),i=new Map,a={};let s=!1,c=0;const u=async()=>{if(s)return;s=!0;for(const[e,t]of i)try{await t.close()}catch{}};for(const o of e)(async()=>{let e;try{e=await this.ensureRelay(o)}catch{return void(r.onerror&&r.onerror("Failed to connect",o))}let l;try{l=await e.subscribe(t,e=>{this.trackRelays&&this.seenOn.set(e.id,o),r.onevent&&r.onevent(e,o)}),i.set(o,l),a[o]=!1}catch(e){return void(r.onerror&&r.onerror(e,o))}l.oneose=()=>{a[o]=!0,Object.values(a).every(Boolean)&&(c++,r.oneose&&r.oneose())}})(x);return{async close(){await u()},id:n}}async get(e,t,r={}){return new Promise(async n=>{const o=this.subscribe(e,t,{...r,onevent:e=>{n(e)},oneose:()=>{n(null)}});setTimeout(()=>{o.close().then(()=>n(null))},r.timeout||3e3)})}async list(e,t,r={}){return new Promise(async n=>{const o=[],i=this.subscribe(e,t,{...r,onevent:e=>{o.push(e)},oneose:()=>{n(o)}});r.timeout&&setTimeout(()=>{i.close().then(()=>n(o))},r.timeout)})}async publish(e,t){const r=L(e,t);return r.then(e=>e.map(e=>e.result))}close(e){const t=this.relays.get(e);t&&(this.relays.delete(e),t.disconnect())}},e.calculateId=A,e.finishEvent=I,e.generatePrivateKey=function(){return a(crypto.getRandomValues(new Uint8Array(32)))},e.getBlankEvent=function(e={}){return{kind:1,created_at:Math.floor(Date.now()/1e3),tags:[],content:"",...e}},e.getEventHash=A,e.getPublicKey=async function(e){const t=await b(e);return a(new Uint8Array(await crypto.subtle.exportKey("raw",t))).slice(2)},e.getSignature=E,e.kinds=B,e.matchFilter=function(e,t){if(t.ids&&!t.ids.some(t=>e.id.startsWith(t)))return!1;if(t.kinds&&-1===t.kinds.indexOf(e.kind))return!1;if(t.authors&&!t.authors.some(t=>e.pubkey===t||e.pubkey.startsWith(t)))return!1;if(t.since&&e.created_at<t.since)return!1;if(t.until&&e.created_at>t.until)return!1;for(const r in t)if(r.startsWith("#")){const n=r.slice(1),o=t[r];if(!e.tags.some(e=>e.length>=2&&e[0]===n&&o.includes(e[1])))return!1}return!0},e.matchFilters=function(e,t){return t.some(t=>e.matchFilter?e.matchFilter(t):matchFilter(e,t))},e.mergeFilters=function(...e){let t={};for(const r of e)Object.entries(r).forEach(([e,r])=>{"object"==typeof r&&Array.isArray(r)?t[e]?t[e]=[...new Set([...t[e],...r])]:t[e]=[...r]:"object"==typeof r?t[e]={...t[e],...r}:t[e]=r});return t},e.nip04={encrypt:async function(e,t,r){const n=s(r),o=crypto.getRandomValues(new Uint8Array(16)),i=crypto.getRandomValues(new Uint8Array(16)),c=await crypto.subtle.importKey("raw",n,{name:"ECDH",namedCurve:"secp256k1"},!1,[]),u=await crypto.subtle.importKey("raw",new Uint8Array([4,...s(t)]),{name:"ECDH",namedCurve:"secp256k1"},!1,[]),l=new Uint8Array(await crypto.subtle.deriveBits({name:"ECDH",public:u},c,256)),f=await crypto.subtle.importKey("raw",l,{name:"AES-CBC",length:256},!1,["encrypt"]),d=new TextEncoder,h=await crypto.subtle.encrypt({name:"AES-CBC",iv:o},f,d.encode(e)),p=new Uint8Array(h);return a(p)+"?iv="+a(o)},decrypt:async function(e,t,r){const n=s(r),o=e.split("?iv="),i=s(o[0]),c=s(o[1]),u=await crypto.subtle.importKey("raw",n,{name:"ECDH",namedCurve:"secp256k1"},!1,[]),l=await crypto.subtle.importKey("raw",new Uint8Array([4,...s(t)]),{name:"ECDH",namedCurve:"secp256k1"},!1,[]),f=new Uint8Array(await crypto.subtle.deriveBits({name:"ECDH",public:l},u,256)),d=await crypto.subtle.importKey("raw",f,{name:"AES-CBC",length:256},!1,["decrypt"]),h=await crypto.subtle.decrypt({name:"AES-CBC",iv:c},d,i);return new TextDecoder().decode(h)}},e.nip05={queryProfile:async function(e,t){const r=e.split("@");if(2!==r.length)throw new Error("Invalid nip05 identifier");const[n,o]=r,i=`https://${o}/.well-known/nostr.json?name=${n}`;try{const e=await fetch(i,t),r=await e.json();if(!r.names||!r.names[n])throw new Error("Name not found");const o=r.names[n];let a=[];return r.relays&&r.relays[o]&&(a=r.relays[o]),{pubkey:o,relays:a}}catch(e){throw new Error(`Failed to fetch nip05 data: ${e.message}`)}}},e.nip10={parse:function(e){const t=[],r=[];let n,o;for(const i of e.tags){if(!Array.isArray(i))continue;if("e"!==i[0])continue;if("string"!=typeof i[1])continue;const e=i[3];if("reply"===e)n=i[1];else if("root"===e)o=i[1];else{const e=i[2];e&&t.includes(e)?r.push(i[1]):t.push(i[1])}}return{reply:n,root:o,mentions:r,profiles:t}}},e.nip13={getPow:function(e){let t=0;const r=s(e);let n=0;for(;n<r.length;n++){const e=r[n];if(0===e)t+=8;else{let r=7;for(;r>=0&&!(e&1<<r);r--)t++;break}}return t},minePow:function(e,t){let r=0;for(;;){const n={...e,tags:[...e.tags,["nonce",r.toString(),t.toString()]]},o=A(n);if(o.startsWith("0".repeat(Math.floor(t/4)))&&(t%4==0||parseInt(o[Math.floor(t/4)],16)<2**(4-t%4)))return n;r++}}},e.nip19={decode:y,encode:w,npubEncode:function(e){return w("npub",s(e))},nsecEncode:function(e){return w("nsec",s(e))},noteEncode:function(e){return w("note",s(e))},nprofileEncode:function(e){let t=new Uint8Array;t=new Uint8Array([...t,0,32,...s(e.pubkey)]);for(const r of e.relays||[])t=new Uint8Array([...t,1,r.length,...new TextEncoder().encode(r)]);return w("nprofile",t)},neventEncode:function(e){let t=new Uint8Array;if(t=new Uint8Array([...t,0,32,...s(e.id)]),e.relays)for(const r of e.relays)t=new Uint8Array([...t,1,r.length,...new TextEncoder().encode(r)]);return e.author&&(t=new Uint8Array([...t,2,32,...s(e.author)])),e.kind&&(t=function(e,t){const r=[];for(;t>0;)r.unshift(255&t),t>>=8;return new Uint8Array([...e,3,r.length,...r])}(t,e.kind)),w("nevent",t)},nrelayEncode:function(e){const t=new TextEncoder().encode(e);return w("nrelay",new Uint8Array([0,t.length,...t]))},naddrEncode:function(e){let t=new Uint8Array;const r=new TextEncoder;if(t=new Uint8Array([...t,0,e.identifier.length,...r.encode(e.identifier)]),t=new Uint8Array([...t,2,32,...s(e.pubkey)]),t=function(e,t){const r=[];for(;t>0;)r.unshift(255&t),t>>=8;return new Uint8Array([...e,3,r.length,...r])}(t,e.kind),e.relays)for(const n of e.relays)t=new Uint8Array([...t,1,n.length,...r.encode(n)]);return w("naddr",t)}},e.nip21={parse:function(e){const t=/^nostr:((note|npub|nprofile|nevent|nrelay|naddr)1[a-z0-9]+)$/i.exec(e);if(!t)throw new Error("Invalid nostr: URI");return y(t[1],t[2])},test:function(e){return/^nostr:/.test(e)}},e.nip27={matchAll:function(e){const t=/(nostr:)?((note|npub|nprofile|nevent|nrelay|naddr)1[a-z0-9]+)/gi,r=[];let n;for(;null!==(n=t.exec(e));){const[e,t,o,i]=n;r.push({start:n.index,end:n.index+e.length,value:o,decoded:y(o,i)})}return r},replaceAll:function(e,t){return e.replace(/(nostr:)?((note|npub|nprofile|nevent|nrelay|naddr)1[a-z0-9]+)/gi,(e,r,n,o)=>t(n,o))}},e.nip28={channelCreateEvent:function(e,t){const r={kind:40,tags:[],content:"",created_at:Math.floor(Date.now()/1e3),...e};return t.name&&(r.tags.push(["name",t.name]),r.content=t.name),t.about&&r.tags.push(["about",t.about]),t.picture&&r.tags.push(["picture",t.picture]),r},channelMetadataEvent:function(e,t,r){const n={kind:41,tags:[["e",e]],content:"",created_at:Math.floor(Date.now()/1e3),...t};return r.name&&(n.tags.push(["name",r.name]),n.content=r.name),r.about&&n.tags.push(["about",r.about]),r.picture&&n.tags.push(["picture",r.picture]),n},channelMessageEvent:function(e,t,r){return{kind:42,tags:[["e",e,"","root"]],content:t,created_at:Math.floor(Date.now()/1e3),...r}},channelHideMessageEvent:function(e,t,r=""){return{kind:43,tags:[["e",t]],content:r,created_at:Math.floor(Date.now()/1e3),...e}},channelMuteUserEvent:function(e,t,r=""){return{kind:44,tags:[["p",t]],content:r,created_at:Math.floor(Date.now()/1e3),...e}}},e.nip39={useMuteList:function(e,t){const r=e.find(e=>10e3===e.kind);if(!r)return{isMuted:!1};const n=r.tags.filter(e=>"p"===e[0]).map(e=>e[1]),o=r.tags.filter(e=>"t"===e[0]).map(e=>e[1]),i=r.tags.filter(e=>"word"===e[0]).map(e=>e[1]),a=r.tags.filter(e=>"e"===e[0]).map(e=>e[1]);if(n.includes(t.pubkey)||a.includes(t.id))return{isMuted:!0,reason:"author or event"};for(const e of t.tags)if("t"===e[0]&&o.includes(e[1]))return{isMuted:!0,reason:"hashtag"};for(const e of i)if(t.content.toLowerCase().includes(e.toLowerCase()))return{isMuted:!0,reason:"word"};return{isMuted:!1}}},e.nip42={makeAuthEvent:function(e,t){if(!e.startsWith("wss://")&&!e.startsWith("ws://"))throw new Error("Invalid relay URL");if("string"!=typeof t||64!==t.length)throw new Error("Invalid challenge");return{kind:22242,tags:[["relay",e],["challenge",t]],content:"",created_at:Math.floor(Date.now()/1e3)}}},e.nip44={v2:{encrypt:async function(e,t,r){const n=s(r),o=await crypto.subtle.importKey("raw",n,{name:"ECDH",namedCurve:"secp256k1"},!1,[]),i=await crypto.subtle.importKey("raw",new Uint8Array([4,...s(t)]),{name:"ECDH",namedCurve:"secp256k1"},!1,[]),c=new Uint8Array(await crypto.subtle.deriveBits({name:"ECDH",public:i},o,256)),u=await l("nip44-v2",c,new Uint8Array(32)),f=crypto.getRandomValues(new Uint8Array(32)),d=await l("nip44-v2",u,f,new Uint8Array(12)),h=await l("nip44-v2",u,f,new Uint8Array(32)),p=s("02"===t.substring(0,2)?t.substring(2):t),g=new Uint8Array([...f,...p]),y=await crypto.subtle.importKey("raw",h,"AES-CTR",!1,["encrypt"]),w=r(e),v=new Uint8Array(2);v[0]=w.length>>8,v[1]=255&w.length;const m=new Uint8Array([...v,...w]),x=await crypto.subtle.encrypt({name:"AES-CTR",counter:d,length:128},y,m),b=new Uint8Array(x),E=await l("nip44-v2",u,new Uint8Array([...g,...b]),new Uint8Array(32));return a(new Uint8Array([2,...f,...b,...E]))},decrypt:async function(e,t,r){const o=s(e);if(o.length<99||2!==o[0])throw new Error("Invalid payload");const i=o.slice(1,33),c=o.slice(33,-32),u=o.slice(-32),d=s(r),h=await crypto.subtle.importKey("raw",d,{name:"ECDH",namedCurve:"secp256k1"},!1,[]),p=await crypto.subtle.importKey("raw",new Uint8Array([4,...s(t)]),{name:"ECDH",namedCurve:"secp256k1"},!1,[]),g=new Uint8Array(await crypto.subtle.deriveBits({name:"ECDH",public:p},h,256)),y=await l("nip44-v2",g,new Uint8Array(32)),w=await l("nip44-v2",y,i,new Uint8Array(12)),v=await l("nip44-v2",y,i,new Uint8Array(32)),m=s("02"===t.substring(0,2)?t.substring(2):t),x=new Uint8Array([...i,...m]),b=await l("nip44-v2",y,new Uint8Array([...x,...c]),new Uint8Array(32));if(!function(e,t){if(e.length!==t.length)return!1;for(let r=0;r<e.length;r++)if(e[r]!==t[r])return!1;return!0}(u,b))throw new Error("Invalid MAC");const E=await crypto.subtle.importKey("raw",v,"AES-CTR",!1,["decrypt"]),_=await crypto.subtle.decrypt({name:"AES-CTR",counter:w,length:128},E,c),k=new Uint8Array(_);if(k.length<2)throw new Error("Invalid decrypted length");const A=k[0]<<8|k[1],S=k.slice(2,2+A);if(S.length!==A)throw new Error("Invalid decrypted length");return n(S)}}},e.nip47={makeNwcRequestEvent:async function(e){const t={method:e.method,params:e.params},r=j(16),n={kind:23194,created_at:e.created_at||Math.floor(Date.now()/1e3),content:await e.nip44.v2.encrypt(JSON.stringify(t),e.walletPubkey,e.secret),tags:[["p",e.walletPubkey]],pubkey:""};return r&&n.tags.push(["nonce",r]),n},parseConnectionString:function(e){const t=e.replace("nostr+walletconnect://","");if(!t.includes("?"))throw new Error("Invalid connection string");const[r,n]=t.split("?"),o=new URLSearchParams(n),i=o.get("relay"),a=o.get("secret");if(!i||!a)throw new Error("Missing relay or secret in connection string");return{walletPubkey:r,relay:i,secret:a}}},e.nip57={getZapEndpoint:async function(e){try{if(!e.nip05)return null;const t=await e.nip05.queryProfile(e.nip05);if(t.pubkey!==e.pubkey)return null;const r=await fetch(`https://${e.nip05.split("@")[1]}/.well-known/lnurlp/${e.nip05.split("@")[0]}`);if(!r.ok)return null;const n=await r.json();return n.allowsNostr&&n.nostrPubkey?n.callback:null}catch{return null}},makeZapRequest:function({profile:e,event:t,amount:r,comment:n="",relays:o=[],recipient:i}){if(!e&&!t)throw new Error("Either profile or event is required");const a={kind:9734,created_at:Math.floor(Date.now()/1e3),content:n,tags:[["amount",r.toString()],["relays",...o]]};return e&&a.tags.push(["p",e]),t&&(a.tags.push(["e",t]),a.tags.push(["p",i||""])),a},makeZapReceipt:function({zapRequest:e,preimage:t,bolt11:r,paidAt:n}){return{kind:9735,created_at:n,content:"",tags:[["bolt11",r],["description",JSON.stringify(e)],["preimage",t],...e.tags.filter(e=>["p","e"].includes(e[0]))]}}},e.nip65={OUTBOX_RELAYS:"wss://purplepag.es/",bestRelaysToReachPubkey:function(e,t){const r=e.filter(e=>10002===e.kind&&e.pubkey===t).sort((e,t)=>t.created_at-e.created_at)[0];if(!r)return[];const n=[];for(const e of r.tags)if("r"===e[0]){const t=e[1],r=e[2];(!r||"read"===r)&&n.push(t)}return n}},e.nip98={getToken:async function(e,t,r,n,o){const i={kind:27235,created_at:Math.floor(Date.now()/1e3),content:"",tags:[["u",e],["method",t]]};return r&&i.tags.push(["payload",a(d(new TextEncoder().encode(r)))]),n&&i.tags.push(["created_at",n.toString()]),o&&i.tags.push(["authorization",o]),"Basic "+btoa(JSON.stringify(await I(i,await b(privateKey))))}},e.normalizeURL=function(e){let t=e.trim();return"https://"!==t.slice(0,8)&&"wss://"!==t.slice(0,6)&&(t="wss://"+t),t.endsWith("/")&&(t=t.slice(0,-1)),t},e.parseReferences=function(e){const t=new Map,r=[],n=[];for(const o of e.tags)if("e"===o[0]&&o[1])if(o[3]&&["reply","root"].includes(o[3])){const e={id:o[1],relay:o[2]||""};"reply"===o[3]?r.push(e):"root"===o[3]&&n.push(e)}else t.has(o[1])||t.set(o[1],o[2]||"");const o=n.length>0?n[0]:null,i=r.length>0?r[r.length-1]:null,a=Array.from(t.entries()).map(([e,t])=>({id:e,relay:t}));return{root:o,reply:i,mentions:a,profiles:q(e).map(e=>({pubkey:e,relay:""}))}},e.relayInit=function(e){return new R(e)},e.serializeEvent=function(e){return r(JSON.stringify([0,e.pubkey,e.created_at,e.kind,e.tags,e.content]))},e.signEvent=E,e.subscribeMany=U,e.tagValues=function(e,t){return e.tags.filter(e=>e[0]===t).map(e=>e[1])},e.uniq=G,e.uniqBy=function(e,t){const r=[];return e.forEach(e=>{const n=t(e);r.find(e=>t(e)===n)||r.push(e)}),r},e.utils={insertEventIntoAscendingList:function(e,t){const r=function(e,t,r=0){let n=r,o=e.length;for(;n<o;){const r=Math.floor((n+o)/2);t(e[r])?o=r:n=r+1}return n}(t,e=>e.created_at>=e.created_at);return t.splice(r,0,e),r},insertEventIntoDescendingList:function(e,t){const r=function(e,t,r=0){let n=r,o=e.length;for(;n<o;){const r=Math.floor((n+o)/2);t(e[r])?n=r+1:o=r}return n}(t,e=>e.created_at>e.created_at);return t.splice(r,0,e),r}},e.validateEvent=T,e.verifySignature=S,e.wrapEvent=async function(e,t,r,n){const o={id:e.id,pubkey:a(crypto.getRandomValues(new Uint8Array(32))),created_at:e.created_at,kind:t,tags:r||[],content:""};return n&&Object.assign(o,n),o.content=await e.nip44.v2.encrypt(JSON.stringify(e),e.pubkey,r),await I(o,await b(privateKey))},Object.defineProperty(e,"__esModule",{value:!0})});
